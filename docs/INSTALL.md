# Установка драйвера ms912x

## Требования

- Linux ядро 6.8 или выше
- DKMS (Dynamic Kernel Module Support)
- Заголовочные файлы ядра Linux

## Установка

### 1. Установка зависимостей

Для Ubuntu/Debian:
```bash
sudo apt update
sudo apt install build-essential linux-headers-$(uname -r) dkms
```

Для Fedora/RHEL:
```bash
sudo dnf install kernel-devel kernel-headers dkms
```

### 2. Сборка и установка драйвера

#### Вариант 1: Установка через DKMS (рекомендуется)

```bash
# Клонирование репозитория (если нужно)
git clone <repository-url>
cd ms912x

# Установка через DKMS
sudo dkms install .

# Загрузка модуля
sudo modprobe drm_shmem_helper
sudo modprobe ms912x
```

#### Вариант 2: Ручная сборка и установка

```bash
# Очистка предыдущей сборки
make clean

# Сборка драйвера
make all -j$(nproc)

# Удаление старого модуля (если есть)
sudo rmmod ms912x 2>/dev/null || true

# Загрузка необходимых модулей
sudo modprobe drm_shmem_helper

# Установка модуля
sudo insmod ms912x.ko
```

### 3. Проверка работы

После подключения устройства USB-VGA/HDMI адаптера проверьте системные логи:

```bash
dmesg | grep ms912x
```

Вы должны увидеть сообщения об успешной инициализации устройства.

Для просмотра информации о дисплеях:
```bash
xrandr --listproviders
```

## Устранение неполадок

### Ошибка "Cannot find any crtc or sizes"

Эта ошибка может возникать по следующим причинам:

1. Проблемы с EDID устройства - драйвер не может получить информацию о поддерживаемых режимах дисплея
2. Неправильное подключение дисплея
3. Проблемы с питанием USB-адаптера

Решения:
- Проверьте подключение дисплея
- Попробуйте другой USB-порт
- Проверьте питание USB (некоторые адаптеры требуют внешнего питания)

### Ошибка DRM_COPY_FIELD

Эта ошибка связана с неправильной реализацией функций версии DRM в драйвере. 
Внесенные изменения должны решить эту проблему.

### Ошибки NVIDIA драйвера

Если в логах присутствуют ошибки NVIDIA драйвера:
```
NVRM: API mismatch
```

Обновите драйвер NVIDIA:
```bash
sudo apt update
sudo ubuntu-drivers autoinstall
# или
sudo apt install nvidia-driver-<version>
```

После установки перезагрузите систему.

## Параметры модуля

Драйвер поддерживает следующие параметры:

- `mode_set` - установка режима дисплея (только для записи)

Пример установки режима:
```bash
sudo sh -c 'echo 0x8100 > /sys/module/ms912x/parameters/mode_set'
```

## Удаление драйвера

### При установке через DKMS:
```bash
sudo dkms remove ms912x --all
```

### При ручной установке:
```bash
sudo rmmod ms912x
```

## Поддерживаемые устройства

- VID/PID: 534d:6021 (USB 2.0)
- VID/PID: 345f:9132 (USB 3.0)

## Совместимость

Драйвер адаптирован для работы с ядром Linux 6.8.
Для других версий ядра используйте соответствующие ветки:
- Для ядра 6.15: ветка kernel-6.15
- Для ядер 6.10-6.12: ветка kernel-6.10